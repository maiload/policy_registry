name: Deploy OPA Policies to NHN Cloud Registry

on:
  push:
    branches: [ main ]
    paths:
      - 'policies/**'
      - '.github/workflows/ncr-policy-deploy.yml'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the policy bundle'
        required: false
        default: 'latest'

env:
  # NHN Cloud Registry ì„¤ì •
  NCR_REGISTRY: ${{ secrets.NCR_REGISTRY }}  # ì˜ˆ: example.kr.ncr.nhncloudservice.com
  NCR_REPOSITORY: policy_registry

jobs:
  build-and-push-policy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install policy CLI
      run: |
        echo "Installing opcr policy CLI..."

        # Homebrew tap ë°©ì‹ ëŒ€ì‹  ì§ì ‘ ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ (Linux í™˜ê²½)
        # Policy CLI ìµœì‹  ë²„ì „ ì„¤ì¹˜
        curl -L https://github.com/opcr-io/policy/releases/latest/download/policy_Linux_x86_64.tar.gz -o policy.tar.gz
        tar -xzf policy.tar.gz
        sudo mv policy /usr/local/bin/
        policy version

        echo "Policy CLI installed successfully"

    - name: Setup build environment
      run: |
        # ë¹Œë“œ ë‚ ì§œì™€ ì»¤ë°‹ ì •ë³´ ì„¤ì •
        echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
        echo "GIT_COMMIT=${GITHUB_SHA::8}" >> $GITHUB_ENV
        echo "GIT_BRANCH=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

    - name: Login to NHN Cloud Registry
      env:
        NCR_USERNAME: ${{ secrets.NCR_ACCESS_KEY }}
        NCR_PASSWORD: ${{ secrets.NCR_SECRET_KEY }}
      run: |
        echo "Logging in to NHN Cloud Registry..."
        policy login \
          -s ${{ env.NCR_REGISTRY }} \
          -u ${{ env.NCR_USERNAME }} \
          -p ${{ env.NCR_PASSWORD }}

        echo "âœ… Successfully logged in to NCR"

    - name: Build policy bundle
      run: |
        # íƒœê·¸ ê²°ì • (workflow_dispatch ìž…ë ¥ ë˜ëŠ” ê¸°ë³¸ê°’)
        if [ "${{ github.event.inputs.tag }}" != "" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG="${{ env.GIT_COMMIT }}"
        fi

        echo "Building policy bundle..."
        echo "Tag: $TAG"

        # Policy ë©”íƒ€ë°ì´í„° íŒŒì¼ ìƒì„± (ì„ íƒì‚¬í•­)
        cat > policies/.policy.yaml <<EOF
        apiVersion: v1
        kind: Policy
        metadata:
          name: opa-policies
          annotations:
            description: "OPA Policies for Application"
            version: "$TAG"
            build-date: "${{ env.BUILD_DATE }}"
            git-commit: "${{ github.sha }}"
            git-branch: "${{ env.GIT_BRANCH }}"
        EOF

        # ì •ì±… ë²ˆë“¤ ë¹Œë“œ
        policy build policies \
          -t ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:$TAG \
          -t ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:latest

        echo "âœ… Policy bundle built successfully"

    - name: Push policy bundle to NCR
      run: |
        # íƒœê·¸ ê²°ì •
        if [ "${{ github.event.inputs.tag }}" != "" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG="${{ env.GIT_COMMIT }}"
        fi

        echo "Pushing policy bundle to NCR..."

        # íŠ¹ì • íƒœê·¸ í‘¸ì‹œ
        policy push ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:$TAG

        # latest íƒœê·¸ë„ í‘¸ì‹œ
        policy push ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:latest

        echo "âœ… Policy bundle pushed successfully"
        echo "ðŸ“¦ Image: ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:$TAG"

    - name: Verify deployment
      run: |
        echo "Verifying policy bundle in registry..."

        # Policy CLIë¥¼ ì‚¬ìš©í•œ ê²€ì¦ (pull í…ŒìŠ¤íŠ¸)
        policy pull ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:latest

        echo "âœ… Verification successful"

    - name: Create deployment summary
      if: success()
      run: |
        cat >> $GITHUB_STEP_SUMMARY <<EOF
        ## ðŸ“¦ Policy Bundle Deployment Summary

        âœ… **Successfully deployed OPA policies to NHN Cloud Registry**

        ### Deployment Details
        - **Registry**: \`${{ env.NCR_REGISTRY }}\`
        - **Repository**: \`${{ env.NCR_REPOSITORY }}\`
        - **Tags**: \`${{ env.GIT_COMMIT }}\`, \`latest\`
        - **Commit**: \`${{ github.sha }}\`
        - **Branch**: \`${{ env.GIT_BRANCH }}\`
        - **Build Date**: \`${{ env.BUILD_DATE }}\`

        ### Pull Command
        \`\`\`bash
        policy pull ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:latest
        \`\`\`

        ### Included Policies
        $(find policies -name "*.rego" -type f | head -20)
        EOF

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Failed to deploy policies to NCR"
        echo "Check the logs above for details"
        exit 1