name: Deploy to NCR

on:
  push:
    branches: [ main ]
    paths:
      - 'policies/**'
  workflow_dispatch:

env:
  NCR_REGISTRY: ${{ secrets.NCR_REGISTRY }}
  NCR_REPOSITORY: policy-registry  # í•˜ì´í”ˆ ì‚¬ìš© (ì–¸ë”ìŠ¤ì½”ì–´ëŠ” Docker Registryì—ì„œ ì§€ì› ì•ˆë¨)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install OPA for bundle creation
      run: |
        # OPAë¥¼ ì‚¬ìš©í•˜ì—¬ ë²ˆë“¤ ìƒì„± (Policy CLI ëŒ€ì‹ )
        curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
        chmod 755 ./opa
        sudo mv ./opa /usr/local/bin/
        opa version

    - name: Create policy bundle
      run: |
        echo "Creating OPA bundle..."

        # ì •ì±… ë””ë ‰í† ë¦¬ í™•ì¸
        if [ ! -d "policies" ]; then
          echo "policies directory not found, creating..."
          mkdir -p policies
          echo 'package example' > policies/example.rego
        fi

        # .manifest íŒŒì¼ ìƒì„±
        cat > .manifest <<EOF
        {
          "revision": "${{ github.sha }}",
          "roots": ["policies"]
        }
        EOF

        # OPA bundle ìƒì„±
        opa build -b policies/ -o bundle.tar.gz

        # Bundle í™•ì¸
        echo "Bundle created:"
        ls -la bundle.tar.gz
        opa inspect bundle.tar.gz

    - name: Setup Docker for NCR
      run: |
        # Dockerë¥¼ ì‚¬ìš©í•˜ì—¬ NCRì— í‘¸ì‹œ
        echo "Preparing Docker image with OPA bundle..."

        # Dockerfile ìƒì„±
        cat > Dockerfile <<EOF
        FROM openpolicyagent/opa:latest-static
        COPY bundle.tar.gz /bundle.tar.gz
        ENTRYPOINT ["/opa", "run", "--server", "--bundle", "/bundle.tar.gz"]
        EOF

        # Docker image ë¹Œë“œ
        docker build -t opa-bundle:local .

    - name: Login to NCR
      uses: docker/login-action@v2
      with:
        registry: ${{ env.NCR_REGISTRY }}
        username: ${{ secrets.NCR_ACCESS_KEY }}
        password: ${{ secrets.NCR_SECRET_KEY }}

    - name: Push to NCR
      run: |
        # íƒœê·¸ ì§€ì •
        docker tag opa-bundle:local ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:${{ github.sha }}
        docker tag opa-bundle:local ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:latest

        # NCRì— í‘¸ì‹œ
        docker push ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:${{ github.sha }}
        docker push ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:latest

        echo "âœ… Successfully pushed to NCR"
        echo "Image: ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:latest"

    - name: Create deployment summary
      if: success()
      run: |
        cat >> $GITHUB_STEP_SUMMARY <<EOF
        ## ðŸ“¦ OPA Bundle Deployment Summary

        âœ… **Successfully deployed to NHN Cloud Registry**

        ### Details
        - **Registry**: \`${{ env.NCR_REGISTRY }}\`
        - **Repository**: \`${{ env.NCR_REPOSITORY }}\`
        - **Tags**: \`${{ github.sha }}\`, \`latest\`

        ### Docker Pull Command
        \`\`\`bash
        docker pull ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:latest
        \`\`\`

        ### Run OPA with Bundle
        \`\`\`bash
        docker run -p 8181:8181 ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}:latest
        \`\`\`
        EOF