name: Deploy to NCR with Policy CLI

on:
  push:
    branches: [ main ]
    paths:
      - 'policies/**'
  workflow_dispatch:

env:
  NCR_REGISTRY: e589d23d-kr1-registry.container.nhncloud.com
  NCR_REPOSITORY: policy_registry
  NCR_IMAGE: bundle

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Policy CLI via Linuxbrew
        run: |
          echo "Installing Policy CLI via Linuxbrew..."

          # Homebrew/Linuxbrew ì„¤ì¹˜ (GitHub Actions Ubuntu runnerì— ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìžˆìŒ)
          # PATH ì„¤ì •
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
          export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"

          # Homebrew ì—…ë°ì´íŠ¸
          brew update

          # opcr-io tap ì¶”ê°€
          brew tap opcr-io/tap

          # Policy CLI ì„¤ì¹˜
          brew install opcr-io/tap/policy

          # ë²„ì „ í™•ì¸
          policy version

          echo "âœ… Policy CLI installed successfully via Linuxbrew"

      - name: Login to NCR
        run: |
          echo "Logging in to NCR..."
          
          # Policy CLIë¡œ NCR ë¡œê·¸ì¸
          policy login \
            -s ${{ env.NCR_REGISTRY }} \
            -u ${{ secrets.NCR_ACCESS_KEY }} \
            -p ${{ secrets.NCR_SECRET_KEY }}
          
          echo "âœ… Successfully logged in to NCR"

      - name: Build and Push Policy Bundle
        run: |
          echo "Building and pushing policy bundle..."

          # ì •ì±… ë””ë ‰í† ë¦¬ í™•ì¸
          if [ ! -d "policies" ]; then
            echo "policies directory not found, creating sample..."
            mkdir -p policies
            cat > policies/example.rego <<EOF
          package example

          default allow = false

          allow {
              input.user == "admin"
          }
          EOF
          fi

          # ì •ì±… íŒŒì¼ ëª©ë¡ í‘œì‹œ
          echo "Policy files:"
          ls -la policies/

          # Policy ë¹Œë“œ
          echo "Building policy bundle..."
          FULL_IMAGE="${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}/${{ env.NCR_IMAGE }}:latest"
          echo "Image path: ${FULL_IMAGE}"

          policy build policies -t ${FULL_IMAGE}

          # Policy push
          echo "Pushing policy bundle to NCR..."
          policy push ${FULL_IMAGE}

          echo "âœ… Successfully built and pushed to NCR"
          echo "ðŸ“¦ Registry: ${{ env.NCR_REGISTRY }}"
          echo "ðŸ“¦ Repository: ${{ env.NCR_REPOSITORY }}"
          echo "ðŸ“¦ Image: ${{ env.NCR_IMAGE }}"
          echo "ðŸ“¦ Tag: latest"

      - name: Verify Deployment
        run: |
          echo "Verifying deployment..."
          
          # Policy pullë¡œ ê²€ì¦
          policy pull ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}/${{ env.NCR_IMAGE }}:latest
          
          echo "âœ… Deployment verified successfully"

      - name: Handle Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed"
          echo "Check the logs above for details"
          
          # ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
          echo "Debug Information:"
          echo "- Registry: ${{ env.NCR_REGISTRY }}"
          echo "- Repository: ${{ env.NCR_REPOSITORY }}"
          echo "- Working Directory: $(pwd)"
          echo "- Policy CLI Version: $(policy version 2>&1 || echo 'Not installed')"
          
          exit 1