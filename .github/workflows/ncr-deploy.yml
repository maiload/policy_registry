name: Deploy to NCR with Policy CLI

on:
  push:
    branches: [ main ]
    paths:
      - 'policies/**'
  workflow_dispatch:

env:
  NCR_REGISTRY: e589d23d-kr1-registry.container.nhncloud.com
  NCR_REPOSITORY: policy_registry
  NCR_IMAGE: bundle

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Policy CLI via Linuxbrew
        run: |
          echo "Installing Policy CLI via Linuxbrew..."

          # Homebrew/Linuxbrew 설치 (GitHub Actions Ubuntu runner에 이미 설치되어 있음)
          # PATH 설정
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
          export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"

          # Homebrew 업데이트
          brew update

          # opcr-io tap 추가
          brew tap opcr-io/tap

          # Policy CLI 설치
          brew install opcr-io/tap/policy

          # 버전 확인
          policy version

          echo "✅ Policy CLI installed successfully via Linuxbrew"

      - name: Login to NCR
        run: |
          echo "Logging in to NCR..."
          
          # Policy CLI로 NCR 로그인
          policy login \
            -s ${{ env.NCR_REGISTRY }} \
            -u ${{ secrets.NCR_ACCESS_KEY }} \
            -p ${{ secrets.NCR_SECRET_KEY }}
          
          echo "✅ Successfully logged in to NCR"

      - name: Build and Push Policy Bundle
        run: |
          echo "Building and pushing policy bundle..."

          # 정책 디렉토리 확인
          if [ ! -d "policies" ]; then
            echo "policies directory not found, creating sample..."
            mkdir -p policies
            cat > policies/example.rego <<EOF
          package example

          default allow = false

          allow {
              input.user == "admin"
          }
          EOF
          fi

          # 정책 파일 목록 표시
          echo "Policy files:"
          ls -la policies/

          # Policy 빌드
          echo "Building policy bundle..."
          FULL_IMAGE="${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}/${{ env.NCR_IMAGE }}:latest"
          echo "Image path: ${FULL_IMAGE}"

          policy build policies -t ${FULL_IMAGE}

          # Policy push
          echo "Pushing policy bundle to NCR..."
          policy push ${FULL_IMAGE}

          echo "✅ Successfully built and pushed to NCR"
          echo "📦 Registry: ${{ env.NCR_REGISTRY }}"
          echo "📦 Repository: ${{ env.NCR_REPOSITORY }}"
          echo "📦 Image: ${{ env.NCR_IMAGE }}"
          echo "📦 Tag: latest"

      - name: Verify Deployment
        run: |
          echo "Verifying deployment..."
          
          # Policy pull로 검증
          policy pull ${{ env.NCR_REGISTRY }}/${{ env.NCR_REPOSITORY }}/${{ env.NCR_IMAGE }}:latest
          
          echo "✅ Deployment verified successfully"

      - name: Handle Failure
        if: failure()
        run: |
          echo "❌ Deployment failed"
          echo "Check the logs above for details"
          
          # 디버그 정보 출력
          echo "Debug Information:"
          echo "- Registry: ${{ env.NCR_REGISTRY }}"
          echo "- Repository: ${{ env.NCR_REPOSITORY }}"
          echo "- Working Directory: $(pwd)"
          echo "- Policy CLI Version: $(policy version 2>&1 || echo 'Not installed')"
          
          exit 1